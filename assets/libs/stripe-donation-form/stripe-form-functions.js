$form=null;jQuery(document).ready(function($){window.DonationForm=window.DonationForm||{};window.DonationForm.active_tab=getUrlParam('tab')||window.DonationForm.active_tab||0;var getQueryParam=function(name){var match=window.location.search.match('[?&]'+name+'=([^&]*)');return match?match[1]:undefined;}
if(getQueryParam('utm_campaign'))
$('.stripe-donation input[name="utm-campaign"]').val(getQueryParam('utm_campaign'));if(getQueryParam('utm_source'))
$('.stripe-donation input[name="utm-source"]').val(getQueryParam('utm_source'));if(getQueryParam('utm_medium'))
$('.stripe-donation input[name="utm-medium"]').val(getQueryParam('utm_medium'));if(getQueryParam('utm_content'))
$('.stripe-donation input[name="utm-content"]').val(getQueryParam('utm_content'));$('.stripe-donation input[name="page-url"]').val(location.href);var amt=$(".stripe-donation-other-amt").val();if($(".amt-button.active").length==1)
amt=$(".amt-button.active").data("amt");$(".monthly_amt").text("of $"+amt+" per month");if($('.stripe-donation').siblings('.stripe-donation').length){var selected_tab=window.DonationForm.active_tab;var tabs='<div id="tabs"><ul class="nav nav-tabs nav-justified"><li role="presentation"><a href="#">Single Gift</a></li><li role="presentation"><a href="#">Monthly Gift</a></li></ul></div>';$('.stripe-donation:eq(0)').addClass('tabbed').before(tabs);$('.stripe-donation:eq(1)').addClass('tabbed');$('#tabs li:eq('+selected_tab+')').addClass('active');if(selected_tab==1)
$('.stripe-donation:eq(0)').hide();else
$('.stripe-donation:eq(1)').hide();$('.stripe-donation:eq(1)').find('.choose-bankaccount').addClass('active');$('.stripe-donation:eq(1)').find('.bank-account-holder, .payment-option-holder').show();$('.stripe-donation:eq(1)').find('.creditcard-holder').hide();$('.stripe-donation:eq(1)').find('.creditcard-holder h4').hide();}
$('.nav-tabs a').on('click',function(e){e.preventDefault();var index=$('.nav-tabs a').index(this);$('.nav-tabs li').removeClass('active');$(this).parent('li').addClass('active');if(index==1)
$('.stripe-donation:eq(0)').hide();else
$('.stripe-donation:eq(1)').hide();$('.stripe-donation:eq('+index+')').show();});$(document).on('change','#recurring',function(){$form=$(this).parents(".stripe-donation-form");if($(this).is(':checked')&&$form.find('.choose-bankaccount').length>0){$form.find('.choose-bankaccount').addClass('active');$form.find('.bank-account-holder, .payment-option-holder').show();$form.find('.creditcard-holder').hide();$form.find('.creditcard-holder h4').hide();}else if($form.find('.choose-bankaccount').length>0){$form.find('.choose-bankaccount').removeClass('active');$form.find('.bank-account-holder, .payment-option-holder').hide();$form.find('.creditcard-holder').show();$form.find('.creditcard-holder h4').show();}});$("#recurring").change();$('.choose-creditcard').on('click',function(){$form=$(this).parents(".stripe-donation-form");$(this).addClass('active');$form.find('.choose-bankaccount').removeClass('active');$form.find('.bank-account-holder').hide();$form.find('.creditcard-holder').show();});$('.choose-bankaccount').on('click',function(){$form=$(this).parents(".stripe-donation-form");$(this).addClass('active');$form.find('.choose-creditcard').removeClass('active');$form.find('.bank-account-holder').show();$form.find('.creditcard-holder').hide();});$(document).on("keyup",".stripe-donation-routing-number",function(){if(this.value.length==9){$.ajax({url:"https://www.routingnumbers.info/api/name.json?rn="+this.value,dataType:'jsonp',success:function(data){if(data.code==200){$('.rn').text(data.name);}}});}else{$('.rn').text('');}});$(document).on("keyup",".stripe-donation-form .stripe-donation-other-amt",function(){$form=$(this).parents(".stripe-donation-form");var valid=/^\d{0,6}(\.\d{0,2})?$/.test(this.value),val=this.value;if(!valid){for(var x=0;x<val.length;x++)
{var charValid=/^\d{0,6}(\.\d{0,2})?$/.test(val.substring(x,x+1))
if(!charValid){this.value=val.substring(0,x)+val.substring(x+1);val=this.value;x--;}}}
else{$form.find(".amt-button").removeClass("active");$form.find(".amt-holder").removeClass("error");$form.find(".monthly_amt").text("of $"+val+" per month");}});$(document).on("keyup",".stripe-donation-card-number",function(e){var valid=/^\d{0,19}?$/.test(this.value),val=this.value;if(!valid)
for(var x=0;x<val.length;x++)
{var charValid=/^\d{0,19}?$/.test(val.substring(x,x+1))
if(!charValid){this.value=val.substring(0,x)+val.substring(x+1);val=this.value;x--;}}});$(document).on("change",".stripe-donation-email",function(){$form=$(this).parents(".stripe-donation-form");var org=$form.find("input[name='org']").val();var data={'action':'marketo_lookup','email':$(this).val(),'org':org};jQuery.post(ajax_object.ajax_url,data,function(response){if(response.success){$form.remove("input[name='stripe-customer-id']");$form.append("<input type='hidden' name='stripe-customer-id' value='"+response.data.id+"' />");}});})
$(".stripe-donation-form .amt-button").click(function(){$form=$(this).parents(".stripe-donation-form");$form.find(".stripe-donation-other-amt").val("");$form.find(".amt-button").removeClass("active");$(this).addClass("active");$form.find(".amt-holder").removeClass("error");$form.find(".monthly_amt").text("of $"+$(this).data("amt")+" per month");});$('.bank-account-tip').on('click hover',function(e){e.stopPropagation();if($(this).next().hasClass('bank-account-tip-image')){$(this).next().toggle();}else{$('<img src="/wp-content/plugins/stripe-donation-form/_img/bank-account-example.png" class="bank-account-tip-image">').insertAfter(this);}
$('body').on('click',function(){$('.bank-account-tip-image').hide();});});jQuery('.stripe-donation-form').validator({delay:1000,disable:false,custom:{creditcard:function($el){if($el.val()=="")
return true;else
return Stripe.card.validateCardNumber($el.val());},allcvv:function($el){$form=$($el).parents(".stripe-donation-form");if($form.find(".stripe-donation-card-number").val()!="")return true;return Stripe.card.validateCVC($el.val());},amexcvv:function($el){$form=$($el).parents(".stripe-donation-form");if($form.find(".stripe-donation-card-number").val()=="")return true;if($el.val().substring(0,1)!="3")return true;return Stripe.card.validateCVC($el.val());},othercvv:function($el){$form=$($el).parents(".stripe-donation-form");if($form.find(".stripe-donation-card-number").val()=="")return true;if($el.val().substring(0,1)=="3")return true;return Stripe.card.validateCVC($el.val());},otheramt:function($el){if($el.val()=="")
return true;return parseFloat($el.val())>=2;},routingnumber:function($el){if($el.val()=="")return true;return Stripe.bankAccount.validateRoutingNumber($el.val(),'US')},accountnumber:function($el){if($el.val()=="")return true;return Stripe.bankAccount.validateAccountNumber($el.val(),'US');},accountnumbercheck:function($el){$form=$($el).parents(".stripe-donation-form");if($el.val()=="")return true;return $el.val()==$form.find('.stripe-donation-account-number').val();},stateerror:function($el){if($el.val()!=""||$el.find("option").length<=1)return true;return false;},email:function($el){var re=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return $el.val()==""||re.test($el.val());}},errors:{creditcard:'The credit card number you entered is not valid',amexcvv:'Invalid verification code. For American Express cards, please enter the 4 digits located on the right-front of your card.',othercvv:'Invalid verification code. Please use the last 3 digits from the signature bar on the back of your card.',allcvv:'Invalid verification code. For American Express cards, please enter the 4 digits located on the right-front of your card. For other cards, please use the last 3 digits from the signature bar on the back of your card.',otheramt:'The minimum gift amount is $2.',routingnumber:'The routing number you entered is not valid.',accountnumber:'The account number you entered is not valid.',accountnumbercheck:'The account numbers you entered do not match.',stateerror:'Please select your state / province',email:'The email format above is incorrect'}});$('.stripe-donation-form').on('submit',function(e){if($("#stripe-donation-test-name").val()!=''){$(".honeypot-holder").show();$(".honeypot-holder .help-block").show();$(".honeypot-holder .col-sm-12").addClass("has-error");return false;}
if(e.isDefaultPrevented()){}else{if(typeof stripe_on_beforesubmit=='function')
try{var keep_going=stripe_on_beforesubmit($(this));if(keep_going!=undefined&&keep_going==false)
return false;}catch(err){}
$form=$(this);$form.find('.btn-primary').data("origText",$form.find('.btn-primary').val());$form.find('.btn-primary').val("Processing...");$(this).find('.btn-primary').prop('disabled',true);Stripe.setPublishableKey($(this).find("input[name='stripe-publishable-key']").val());if($form.find('.choose-bankaccount').hasClass('active')){Stripe.bankAccount.createToken({country:$(this).find('.stripe-donation-country').val(),currency:'USD',routing_number:$(this).find('.stripe-donation-routing-number').val(),account_number:$(this).find('.stripe-donation-account-number').val(),account_holder_name:$(this).find('.stripe-donation-first-name').val()+" "+$(this).find('.stripe-donation-last-name').val(),account_holder_type:'individual'},stripe_response_handler);}else{var cardObj={number:$(this).find('.stripe-donation-card-number').val(),exp_month:$(this).find('.stripe-donation-exp-month').val(),exp_year:$(this).find('.stripe-donation-exp-year').val(),name:$(this).find('.stripe-donation-first-name').val()+" "+$(this).find('.stripe-donation-last-name').val(),address_line1:$(this).find('.stripe-donation-address').val(),address_city:$(this).find('.stripe-donation-city').val(),address_zip:$(this).find('.stripe-donation-zip').val(),address_state:$(this).find('.stripe-donation-state').val(),address_country:$(this).find('.stripe-donation-country').val()};if($(this).find('.stripe-donation-card-cvc')[0].hasAttribute('data-stripe')){cardObj.cvc=$(this).find('.stripe-donation-card-cvc').val();}
Stripe.card.createToken(cardObj,stripe_response_handler);}
return false;}});if(typeof stripe_on_show=='function')
try{stripe_on_show();}catch(err){}});function stripe_response_handler(status,response){if(response.error){$form.find('.btn-primary').removeAttr("disabled").val($form.find('.btn-primary').data("origText"));$form.find(".payment-errors").show().html("<h4 style='margin-top:50px;'>There was an error processing your card:</h4><p style='margin-bottom:50px;'>"+response.error.message+"</p>");jQuery("html, body").animate({scrollTop:$form.find(".payment-errors").offset().top},500);}else{var amt=$form.find(".stripe-donation-other-amt").val();if($form.find(".amt-button.active").length==1)
amt=$form.find(".amt-button.active").data("amt");var token=response['id'];var data={'action':'process_stripe_donation','stripe-token':token,'amount':amt,'marketo-token':get_cookie('_mkto_trk')};if(response['type']=='bank_account'){data.bank_account_id=response.bank_account.id;}
$form.find("input,select").each(function(){if(jQuery(this).prop("name")&&((!jQuery(this).is("[type='radio']")&&!jQuery(this).is("[type='checkbox']"))||jQuery(this).is(":checked")))
data[jQuery(this).prop("name")]=jQuery(this).val();});var req={url:ajax_object.ajax_url,data:data,success:function(response){var obj=jQuery.parseJSON(response);console.log(obj);if(obj.object&&(obj.object=="charge"||obj.object=="subscription")){if(jQuery("#send_receipt").length==0||jQuery("#send_receipt").is(":checked")){data["action"]="marketo_receipt";data['stripe-customer-id']=obj.customer;if(obj.object=="subscription"){data['stripe-subscription-id']=obj.id;}
jQuery.post(ajax_object.ajax_url,data,function(response){});}
$form.hide();$form.after("<div style=\"margin-top:50px; margin-bottom:50px;\" id=\"receipt-thank-you\">"+obj.thank_you_message+"</div>");jQuery('html, body').animate({scrollTop:jQuery("#receipt-thank-you").offset().top},100);$form.trigger('donation:transaction_complete',[obj]);jQuery('#tabs').hide();jQuery('.stripe-donation').removeClass('tabbed');if(typeof stripe_on_complete=='function')
try{stripe_on_complete(obj);}catch(err){}}
else{if(typeof stripe_on_error=='function')
try{stripe_on_error(obj);}catch(err){}
$form.find('.btn-primary').removeAttr("disabled").val($form.find('.btn-primary').data("origText"));;$form.find(".payment-errors").show().html("<h4>There was an error processing your card:</h4><p>"+obj+"</p>");jQuery("html, body").animate({scrollTop:$form.find(".payment-errors").offset().top},500);}},error:function(xhr){var response=xhr.responseJSON;console.log('error',response);if(typeof donate_on_error=='function')
try{donate_on_error(response);}catch(err){}
$form.find('.btn-primary').removeAttr("disabled").val($form.find('.btn-primary').data("origText"));$form.find(".payment-errors").show().html("<h4>There was an error processing your card:</h4><p>"+response.data.msg+"</p>");jQuery("html, body").animate({scrollTop:$form.find(".payment-errors").offset().top-100},500);}}
send_secure_request(req,'process_donation');}}
function send_secure_request($params,$action){if(typeof DonationForm!=="undefined"&&typeof DonationForm.sitekey!=="undefined"){grecaptcha.execute(DonationForm.sitekey,{action:$action}).then(function(token){if(typeof $params.data=='object')
$params.data=jQuery.param($params.data);$params.data+='&g-recaptcha-response='+token;jQuery.post($params);});}else{jQuery.post($params);}}
function get_cookie(name){var nameEQ=name+"=";var ca=document.cookie.split(';');for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)==' ')c=c.substring(1,c.length);if(c.indexOf(nameEQ)==0)return c.substring(nameEQ.length,c.length);}
return null;}